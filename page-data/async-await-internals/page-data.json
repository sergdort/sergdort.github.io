{"componentChunkName":"component---src-templates-blog-post-js","path":"/async-await-internals/","result":{"data":{"site":{"siteMetadata":{"title":"Journey before destination, tests before production"}},"markdownRemark":{"id":"239dbc59-49bc-584e-aca2-e2432602ea43","excerpt":"When you write  code, it feels magical—asynchronous operations look like synchronous code, yet your program doesn’t block. But what’s actually happening under…","html":"<p>When you write <code class=\"language-text\">async/await</code> code, it feels magical—asynchronous operations look like synchronous code, yet your program doesn’t block. But what’s actually happening under the hood? How does Swift transform your sequential-looking code into non-blocking, resumable operations?</p>\n<p>In this deep dive, we’ll explore the internal mechanisms that make async/await work in Swift. We’ll examine state machines, continuations, async frames, and executor management to understand how the language achieves efficient asynchronous programming.</p>\n<h2>The Core Problem</h2>\n<p>Before async/await, asynchronous programming meant callbacks, manual state tracking, and complex control flow:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">// The old way - callback hell</span>\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">fetchUserData</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> completion<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">fetchFromDatabase</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> userId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> userData <span class=\"token keyword\">in</span>\n        <span class=\"token function\">fetchUserPreferences</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> userId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> preferences <span class=\"token keyword\">in</span>\n            <span class=\"token function\">fetchUserPosts</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> userId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> posts <span class=\"token keyword\">in</span>\n                <span class=\"token keyword\">let</span> user <span class=\"token operator\">=</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>userData<span class=\"token punctuation\">:</span> userData<span class=\"token punctuation\">,</span> preferences<span class=\"token punctuation\">:</span> preferences<span class=\"token punctuation\">,</span> posts<span class=\"token punctuation\">:</span> posts<span class=\"token punctuation\">)</span>\n                <span class=\"token function\">completion</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>With async/await, this becomes:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">// The modern way</span>\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">fetchUserData</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">User</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> userData <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetchFromDatabase</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> userId<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> preferences <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetchUserPreferences</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> userId<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> posts <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetchUserPosts</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">:</span> userId<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>userData<span class=\"token punctuation\">:</span> userData<span class=\"token punctuation\">,</span> preferences<span class=\"token punctuation\">:</span> preferences<span class=\"token punctuation\">,</span> posts<span class=\"token punctuation\">:</span> posts<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The challenge: how do we make this sequential-looking code actually suspend, free up the thread, and resume later without blocking?</p>\n<h2>The State Machine Transformation</h2>\n<p>Swift solves this problem by transforming your async function into a <strong>state machine</strong> at compile time. Each <code class=\"language-text\">await</code> point becomes a distinct state.</p>\n<h3>Swift’s Async Frame Approach</h3>\n<p>When you write an async function, Swift allocates an <strong>async frame</strong> that persists across suspension points.</p>\n<p>Here’s what you write:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Int</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> processed <span class=\"token operator\">=</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> processed\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Swift allocates an async frame that conceptually looks like:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">┌────────────────────────┐\n│   Async Frame          │\n├────────────────────────┤\n│ Parent frame pointer   │\n│ Resume function ptr    │\n│ Resume point (state)   │\n│ Executor reference     │\n│ Local: result          │\n│ Local: processed       │\n└────────────────────────┘</code></pre></div>\n<p>Unlike regular stack frames (which are destroyed when a function returns), async frames are heap-allocated and persist across suspension points. They form a linked chain through parent pointers, similar to a call stack but with the crucial difference that they can survive when the function suspends.</p>\n<h3>How the State Machine Works</h3>\n<p>The compiler transforms your async function into something conceptually like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">// Conceptual transformation (simplified)</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">GetDataAsyncFrame</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Current state in the state machine</span>\n    <span class=\"token keyword\">var</span> state<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span>\n\n    <span class=\"token comment\">// Local variables that survive across await</span>\n    <span class=\"token keyword\">var</span> result<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Data</span><span class=\"token operator\">?</span>\n    <span class=\"token keyword\">var</span> processed<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span><span class=\"token operator\">?</span>\n\n    <span class=\"token comment\">// Parent frame pointer</span>\n    <span class=\"token keyword\">var</span> parentFrame<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnsafePointer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">AsyncFrame</span><span class=\"token operator\">>?</span>\n\n    <span class=\"token comment\">// Resume function</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">resume</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">switch</span> state <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\">// Initial state - start fetch()</span>\n            state <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n            <span class=\"token comment\">// Suspend and wait for fetch() to complete</span>\n            <span class=\"token keyword\">return</span>\n\n        <span class=\"token keyword\">case</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\">// Resumed after fetch() completed</span>\n            result <span class=\"token operator\">=</span> <span class=\"token function\">getAwaitResult</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            processed <span class=\"token operator\">=</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span>result<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span>\n            state <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token comment\">// Mark as completed</span>\n            <span class=\"token function\">completeAsync</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">:</span> processed<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The key insight: <strong>all local variables that need to survive across <code class=\"language-text\">await</code> points are stored in the async frame</strong>. This moves them from the stack to the heap, ensuring they persist when the method yields control.</p>\n<p>When you <code class=\"language-text\">await</code>, the method doesn’t actually wait—it:</p>\n<ol>\n<li>Saves the current state</li>\n<li>Registers a continuation (the resume function)</li>\n<li>Returns control to the caller</li>\n<li>Later, when the awaited operation completes, the resume function is called</li>\n</ol>\n<h2>Understanding Continuations</h2>\n<p>Continuations are the <strong>core mechanism</strong> that makes resumption work. A continuation is essentially “the rest of the computation”—it packages up everything needed to resume execution later.</p>\n<h3>What’s in a Continuation?</h3>\n<p>Think of a continuation as a bookmark that contains:</p>\n<ul>\n<li><strong>Where to resume</strong>: The specific point in the code to continue from</li>\n<li><strong>What state to restore</strong>: The local variables and context</li>\n<li><strong>Where to run</strong>: Which executor/scheduler to use when resuming</li>\n</ul>\n<p>In Swift, a continuation conceptually looks like:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">UnsafeContinuation</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Pointer to the async frame to resume</span>\n    <span class=\"token keyword\">var</span> asyncFrame<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnsafePointer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">AsyncFrame</span><span class=\"token operator\">></span>\n\n    <span class=\"token comment\">// The function to call to resume execution</span>\n    <span class=\"token keyword\">var</span> resumeFunction<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@convention</span><span class=\"token punctuation\">(</span>thin<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">UnsafePointer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">AsyncFrame</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Void</span>\n\n    <span class=\"token comment\">// Which executor to resume on</span>\n    <span class=\"token keyword\">var</span> targetExecutor<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnownedSerialExecutor</span>\n\n    <span class=\"token comment\">// Priority and other metadata</span>\n    <span class=\"token keyword\">var</span> priority<span class=\"token punctuation\">:</span> <span class=\"token class-name\">TaskPriority</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Creating a Continuation</h3>\n<p>Let’s trace what happens when you <code class=\"language-text\">await</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">fetchUser</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">User</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">networkRequest</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span> <span class=\"token comment\">// ← Suspension point</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>At the <code class=\"language-text\">await networkRequest(id)</code> line:</p>\n<ol>\n<li>\n<p><strong>The compiler generates code to create a continuation:</strong></p>\n<ul>\n<li>Captures the current async frame</li>\n<li>Sets the resume point (state 1 in our example)</li>\n<li>Captures the current executor</li>\n</ul>\n</li>\n<li>\n<p><strong>The async frame is updated:</strong></p>\n<ul>\n<li>Resume point set to 1</li>\n<li>Current state saved</li>\n<li>Live variables preserved</li>\n</ul>\n</li>\n<li>\n<p><strong>Control returns to the runtime scheduler:</strong></p>\n<ul>\n<li>The current thread is freed up</li>\n<li>Other work can execute</li>\n</ul>\n</li>\n</ol>\n<h3>Resuming a Continuation</h3>\n<p>When the async operation completes, someone calls <code class=\"language-text\">continuation.resume()</code>. Here’s what happens internally:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">resume</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>continuation<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnsafeContinuation</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> with value<span class=\"token punctuation\">:</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 1. Get the async frame</span>\n    <span class=\"token keyword\">let</span> frame <span class=\"token operator\">=</span> continuation<span class=\"token punctuation\">.</span>asyncFrame\n\n    <span class=\"token comment\">// 2. Store the result value in the frame</span>\n    <span class=\"token function\">storeResult</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">in</span><span class=\"token punctuation\">:</span> frame<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">:</span> value<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// 3. Check if we need to switch executors</span>\n    <span class=\"token keyword\">let</span> targetExecutor <span class=\"token operator\">=</span> continuation<span class=\"token punctuation\">.</span>targetExecutor\n    <span class=\"token keyword\">let</span> currentExecutor <span class=\"token operator\">=</span> <span class=\"token function\">getCurrentExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> currentExecutor <span class=\"token operator\">==</span> targetExecutor <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Already on correct executor - resume directly</span>\n        continuation<span class=\"token punctuation\">.</span><span class=\"token function\">resumeFunction</span><span class=\"token punctuation\">(</span>frame<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Need to hop to the target executor</span>\n        targetExecutor<span class=\"token punctuation\">.</span>enqueue <span class=\"token punctuation\">{</span>\n            continuation<span class=\"token punctuation\">.</span><span class=\"token function\">resumeFunction</span><span class=\"token punctuation\">(</span>frame<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The resume function jumps back into the async function at the right state:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">resumeFetchUser</span><span class=\"token punctuation\">(</span>frame<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnsafePointer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">AsyncFrame</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Restore local state from frame</span>\n    <span class=\"token keyword\">let</span> locals <span class=\"token operator\">=</span> <span class=\"token function\">loadLocals</span><span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">:</span> frame<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// Jump to the right state</span>\n    <span class=\"token keyword\">switch</span> locals<span class=\"token punctuation\">.</span>resumePoint <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\">// Resume after networkRequest</span>\n        <span class=\"token keyword\">let</span> user <span class=\"token operator\">=</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">completeAsync</span><span class=\"token punctuation\">(</span>frame<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">:</span> user<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n        <span class=\"token function\">fatalError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Manual Continuation API</h3>\n<p>Swift exposes continuations through APIs that let you bridge callback-based code to async/await:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">legacyAsyncOperation</span><span class=\"token punctuation\">(</span>completion<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Result</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Error</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Old-style callback API</span>\n    <span class=\"token class-name\">DispatchQueue</span><span class=\"token punctuation\">.</span><span class=\"token function\">global</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">asyncAfter</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">completion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Done!\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Bridge to async/await using continuation:</span>\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">modernAsyncOperation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">try</span> <span class=\"token keyword\">await</span> withCheckedThrowingContinuation <span class=\"token punctuation\">{</span> continuation <span class=\"token keyword\">in</span>\n        legacyAsyncOperation <span class=\"token punctuation\">{</span> result <span class=\"token keyword\">in</span>\n            <span class=\"token comment\">// Resume the continuation with the result</span>\n            continuation<span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span>with<span class=\"token punctuation\">:</span> result<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">withCheckedThrowingContinuation</code> function:</p>\n<ol>\n<li>Creates a continuation for the current suspension point</li>\n<li>Passes it to your closure</li>\n<li>Suspends the async function</li>\n<li>Your closure stores the continuation and starts the async operation</li>\n<li>When the callback fires, you resume the continuation</li>\n<li>The async function continues execution</li>\n</ol>\n<h3>Continuation Safety</h3>\n<p>Continuations must be resumed exactly once. Swift provides both checked and unsafe versions:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">// Checked - runtime verifies you resume exactly once</span>\nwithCheckedContinuation <span class=\"token punctuation\">{</span> continuation <span class=\"token keyword\">in</span>\n    continuation<span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span>returning<span class=\"token punctuation\">:</span> <span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// continuation.resume(returning: 43) // ← Runtime error!</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Unsafe - no checking, better performance</span>\nwithUnsafeContinuation <span class=\"token punctuation\">{</span> continuation <span class=\"token keyword\">in</span>\n    continuation<span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span>returning<span class=\"token punctuation\">:</span> <span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// Resuming twice = undefined behavior!</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Resuming twice leads to crashes and memory corruption. Never resuming causes the async function to hang forever and leak memory. The checked version protects you from these errors at the cost of some runtime overhead.</p>\n<h2>Executor Management and Context Switching</h2>\n<p>One of the most elegant aspects of Swift’s async/await is how it manages execution context—ensuring that code runs on the correct executor (thread pool, main queue, actor’s serial queue, etc.).</p>\n<h3>How Executors Are Tracked</h3>\n<p>The key is <strong>task-local storage</strong>. Each Task carries metadata including the current executor:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">Task</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> id<span class=\"token punctuation\">:</span> <span class=\"token class-name\">TaskID</span>\n    <span class=\"token keyword\">var</span> priority<span class=\"token punctuation\">:</span> <span class=\"token class-name\">TaskPriority</span>\n    <span class=\"token keyword\">var</span> asyncFrameChain<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnsafePointer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">AsyncFrame</span><span class=\"token operator\">></span>\n\n    <span class=\"token comment\">// Current executor stored per-task</span>\n    <span class=\"token keyword\">var</span> currentExecutor<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnownedSerialExecutor</span>\n\n    <span class=\"token keyword\">var</span> parentTask<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Task</span><span class=\"token operator\">?</span>\n    <span class=\"token comment\">// ... other metadata</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>When you call <code class=\"language-text\">getCurrentExecutor()</code>, it essentially does:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">swift_task_getCurrentExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">UnownedSerialExecutor</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> currentTask <span class=\"token operator\">=</span> <span class=\"token function\">swift_task_getCurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// Get current Task</span>\n    <span class=\"token keyword\">return</span> currentTask<span class=\"token punctuation\">.</span>currentExecutor  <span class=\"token comment\">// Return stored executor</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>How the Current Task is Tracked</h3>\n<p>The runtime maintains a pointer to the current task in each OS thread using thread-local storage:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// In each OS thread's thread-local storage</span>\n__thread Task<span class=\"token operator\">*</span> _currentTask <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Getting current task</span>\nTask<span class=\"token operator\">*</span> <span class=\"token function\">swift_task_getCurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> _currentTask<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>So the complete chain is:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">OS Thread\n   │\n   └─> _currentTask (thread-local pointer)\n          │\n          └─> Task object (heap allocated)\n                 │\n                 └─> currentExecutor field</code></pre></div>\n<p>This indirection is crucial: it allows tasks to migrate between threads while maintaining their execution context.</p>\n<h3>Executor Switching with Actors</h3>\n<p>Actors in Swift guarantee that their methods run serially on their own executor. Here’s how that works with continuations:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">actor</span> <span class=\"token class-name\">DatabaseActor</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> state<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">save</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Data</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Runs on DatabaseActor's executor</span>\n        <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">networkRequest</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// Automatically back on DatabaseActor's executor!</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>  <span class=\"token comment\">// Safe - isolated to actor</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>The flow:</strong></p>\n<ol>\n<li>\n<p><strong>Before <code class=\"language-text\">await networkRequest()</code>:</strong></p>\n<ul>\n<li>Currently on DatabaseActor’s executor</li>\n<li><code class=\"language-text\">Task.currentExecutor = DatabaseActor.executor</code></li>\n<li>Continuation captures this executor as <code class=\"language-text\">targetExecutor</code></li>\n</ul>\n</li>\n<li>\n<p><strong><code class=\"language-text\">networkRequest()</code> executes:</strong></p>\n<ul>\n<li>May run on a completely different executor</li>\n<li>Might complete on a background thread</li>\n</ul>\n</li>\n<li>\n<p><strong>When <code class=\"language-text\">networkRequest()</code> completes:</strong></p>\n<ul>\n<li>Calls <code class=\"language-text\">continuation.resume(returning: result)</code></li>\n<li>Runtime checks: am I on the target executor?</li>\n<li>If not, enqueues the resume operation on DatabaseActor’s executor</li>\n</ul>\n</li>\n<li>\n<p><strong>Resume executes:</strong></p>\n<ul>\n<li>Now back on DatabaseActor’s executor</li>\n<li><code class=\"language-text\">Task.currentExecutor</code> is updated</li>\n<li>Actor isolation is restored</li>\n<li>Safe to access <code class=\"language-text\">self.state</code></li>\n</ul>\n</li>\n</ol>\n<h3>Setting the Executor</h3>\n<p>The executor is set or changed at specific points:</p>\n<p><strong>1. Task Creation:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">// Inherits current executor</span>\n<span class=\"token class-name\">Task</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// currentExecutor = parent's executor</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">doWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Gets new executor from thread pool</span>\n<span class=\"token class-name\">Task</span><span class=\"token punctuation\">.</span>detached <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// currentExecutor = cooperative thread pool executor</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">doWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Explicitly on main executor</span>\n<span class=\"token class-name\">Task</span> <span class=\"token punctuation\">{</span> <span class=\"token attribute atrule\">@MainActor</span> <span class=\"token keyword\">in</span>\n    <span class=\"token comment\">// currentExecutor = MainActor's executor (main queue)</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">updateUI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>2. Entering Actor-Isolated Context:</strong></p>\n<p>When you call an actor method, the runtime switches executors:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> <span class=\"token keyword\">actor</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">MyActor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">await</span> <span class=\"token keyword\">actor</span><span class=\"token punctuation\">.</span><span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// ← Executor switch happens here</span></code></pre></div>\n<p>Internally:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">callActorMethod</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">actor</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">MyActor</span><span class=\"token punctuation\">,</span> method<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> currentTask <span class=\"token operator\">=</span> <span class=\"token function\">swift_task_getCurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// Switch to actor's executor</span>\n    currentTask<span class=\"token punctuation\">.</span>currentExecutor <span class=\"token operator\">=</span> <span class=\"token keyword\">actor</span><span class=\"token punctuation\">.</span>unownedExecutor\n\n    <span class=\"token comment\">// Enqueue the method call on actor's executor</span>\n    <span class=\"token keyword\">actor</span><span class=\"token punctuation\">.</span>unownedExecutor<span class=\"token punctuation\">.</span>enqueue <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// Execute on actor's executor</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>3. Resuming from Continuation:</strong></p>\n<p>When a continuation resumes, it restores the executor:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">resume</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>continuation<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Continuation</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> with value<span class=\"token punctuation\">:</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> targetExecutor <span class=\"token operator\">=</span> continuation<span class=\"token punctuation\">.</span>targetExecutor\n\n    targetExecutor<span class=\"token punctuation\">.</span>enqueue <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> currentTask <span class=\"token operator\">=</span> <span class=\"token function\">swift_task_getCurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        currentTask<span class=\"token punctuation\">.</span>currentExecutor <span class=\"token operator\">=</span> targetExecutor  <span class=\"token comment\">// ← Restored here!</span>\n        continuation<span class=\"token punctuation\">.</span><span class=\"token function\">resumeFunction</span><span class=\"token punctuation\">(</span>continuation<span class=\"token punctuation\">.</span>frame<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Complete Example: Tracing Executor Changes</h3>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">actor</span> <span class=\"token class-name\">DatabaseActor</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"A: </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\"><span class=\"token function\">getCurrentExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// DatabaseActor's executor</span>\n\n        <span class=\"token keyword\">await</span> <span class=\"token class-name\">Task</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"B: </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\"><span class=\"token function\">getCurrentExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// Inherited from parent</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span>value\n\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"C: </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\"><span class=\"token function\">getCurrentExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// DatabaseActor's executor</span>\n\n        <span class=\"token keyword\">await</span> <span class=\"token class-name\">Task</span><span class=\"token punctuation\">.</span>detached <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"D: </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\"><span class=\"token function\">getCurrentExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// New executor</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span>value\n\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"E: </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\"><span class=\"token function\">getCurrentExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// DatabaseActor's executor</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>What prints:</strong></p>\n<ul>\n<li><strong>A:</strong> DatabaseActor’s executor (we’re in an actor method)</li>\n<li><strong>B:</strong> DatabaseActor’s executor (child Task inherits parent’s executor)</li>\n<li><strong>C:</strong> DatabaseActor’s executor (continuation restored it after await)</li>\n<li><strong>D:</strong> DefaultExecutor (detached task gets new executor)</li>\n<li><strong>E:</strong> DatabaseActor’s executor (continuation restored it again)</li>\n</ul>\n<h2>Performance Optimizations</h2>\n<p>Swift has optimizations to avoid unnecessary overhead:</p>\n<h3>Inline Frames</h3>\n<p>Swift can optimize away frame allocation for simple cases:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">simple</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Int</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">42</span>  <span class=\"token comment\">// No suspension - might not allocate frame</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">alsoSimple</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Int</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> x <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">simple</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// Might inline simple's \"frame\"</span>\n    <span class=\"token keyword\">return</span> x\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If the compiler can prove an async function won’t actually suspend, it can optimize away the frame allocation entirely. This is similar to function inlining but for async operations.</p>\n<h3>Frame Reuse</h3>\n<p>For async functions called in a loop, Swift can reuse async frames instead of allocating new ones each iteration:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">processItems</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> items<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">Item</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> item <span class=\"token keyword\">in</span> items <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span>  <span class=\"token comment\">// Frame can be reused across iterations</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Practical Implications</h2>\n<p>Understanding these internals helps you write better async code:</p>\n<h3>1. Local Variables and Captures</h3>\n<p>Variables that cross <code class=\"language-text\">await</code> boundaries are stored in the async frame:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">processData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> largeObject <span class=\"token operator\">=</span> <span class=\"token class-name\">LargeObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// Allocated</span>\n    <span class=\"token keyword\">await</span> <span class=\"token class-name\">Task</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span>nanoseconds<span class=\"token punctuation\">:</span> <span class=\"token number\">1_000_000_000</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// largeObject kept alive in async frame</span>\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>largeObject<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">largeObject</code> is kept alive for the entire duration. If you don’t need it after the await, consider scoping it:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">processData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> largeObject <span class=\"token operator\">=</span> <span class=\"token class-name\">LargeObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">processSync</span><span class=\"token punctuation\">(</span>largeObject<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>  <span class=\"token comment\">// largeObject can be deallocated</span>\n    <span class=\"token keyword\">await</span> <span class=\"token class-name\">Task</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span>nanoseconds<span class=\"token punctuation\">:</span> <span class=\"token number\">1_000_000_000</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Done\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>2. Continuation Safety</h3>\n<p>Never resume a continuation more than once:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">// WRONG - potential double resume</span>\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">dangerous</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Int</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> withUnsafeContinuation <span class=\"token punctuation\">{</span> continuation <span class=\"token keyword\">in</span>\n        performAsync <span class=\"token punctuation\">{</span> result <span class=\"token keyword\">in</span>\n            continuation<span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span>returning<span class=\"token punctuation\">:</span> result<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        continuation<span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span>returning<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// ← BUG!</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Use checked continuations during development to catch these errors.</p>\n<h3>3. Executor Awareness</h3>\n<p>Be aware of executor hops:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">actor</span> <span class=\"token class-name\">MyActor</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetchData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// Executor hop out</span>\n        <span class=\"token comment\">// Executor hop back to MyActor</span>\n        <span class=\"token keyword\">await</span> <span class=\"token function\">saveData</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>  <span class=\"token comment\">// Executor hop out</span>\n        <span class=\"token comment\">// Executor hop back to MyActor</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Each <code class=\"language-text\">await</code> potentially involves executor switching. For performance-critical code, consider batching operations.</p>\n<h3>4. Avoiding Unnecessary Suspensions</h3>\n<p>If an operation might complete synchronously, you can avoid suspension overhead:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">getCachedOrFetch</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Value</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Check cache first - no suspension needed</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> cached <span class=\"token operator\">=</span> cache<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> cached\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// Only suspend if we need to fetch</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetchFromNetwork</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Conclusion</h2>\n<p>Async/await may look like magic, but it’s built on elegant compiler transformations and runtime support:</p>\n<ul>\n<li><strong>State machines</strong> transform your sequential code into resumable operations</li>\n<li><strong>Continuations</strong> package up “what comes next” so execution can resume later</li>\n<li><strong>Async frames</strong> preserve local state across suspension points</li>\n<li><strong>Executor management</strong> ensures code runs in the right context</li>\n</ul>\n<p>Understanding these internals helps you:</p>\n<ul>\n<li>Write more efficient async code</li>\n<li>Debug async issues more effectively</li>\n<li>Make better architectural decisions</li>\n<li>Appreciate the engineering behind Swift’s concurrency model</li>\n</ul>\n<p>The beauty of async/await is that while the internals are complex, the programming model is simple—you write code that looks synchronous but gets all the benefits of non-blocking I/O.</p>\n<hr>\n<p><em>Want to dive deeper? Check out the <a href=\"https://gist.github.com/lattner/31ed37682ef1576b16bca1432ea9f782\">Swift Concurrency Manifesto</a> and <a href=\"https://github.com/apple/swift-evolution/blob/main/proposals/0296-async-await.md\">Swift Evolution proposals SE-0296</a> for more detailed technical discussions.</em></p>","frontmatter":{"title":"Deep Dive: How Async/Await Works Under the Hood in Swift","date":"January 17, 2026","tags":["async","concurrency","Swift","programming-languages","internals"]}},"previous":null,"next":{"fields":{"slug":"/swiftui-navigation-done-right/"},"frontmatter":{"title":"SwiftUI Navigation Done Right"}}},"pageContext":{"id":"239dbc59-49bc-584e-aca2-e2432602ea43","slug":"/async-await-internals/","previousPostId":null,"nextPostId":"4d2739c4-0f36-5dcc-920f-02b28c7fe34f"}},"staticQueryHashes":["63159454"],"slicesMap":{}}