{"componentChunkName":"component---src-templates-blog-post-js","path":"/tasklocal-swift/","result":{"data":{"site":{"siteMetadata":{"title":"Journey before destination, tests before production"}},"markdownRemark":{"id":"b1e4f645-af8f-5ee4-a2eb-cd99156f2003","excerpt":"Swift’s structured concurrency brought us async/await, actors, and task groups. But there’s one feature that often flies under the radar despite being…","html":"<p>Swift’s structured concurrency brought us async/await, actors, and task groups. But there’s one feature that often flies under the radar despite being incredibly powerful: <strong>TaskLocal</strong>. If you’ve ever wrestled with passing context through layers of async functions, or wondered how Point-Free’s <a href=\"https://github.com/pointfreeco/swift-dependencies\">@Dependency</a> library works its magic, you’re in the right place.</p>\n<h2>What is TaskLocal?</h2>\n<p>TaskLocal is Swift’s solution to propagating context through asynchronous task hierarchies. Think of it as thread-local storage reimagined for the async/await world.</p>\n<p>At its core, TaskLocal allows you to associate values with the current task and have those values automatically propagate to child tasks. It’s declared using the <code class=\"language-text\">@TaskLocal</code> property wrapper:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">MyContext</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute atrule\">@TaskLocal</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> requestID<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span>\n    <span class=\"token attribute atrule\">@TaskLocal</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> userID<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span><span class=\"token operator\">?</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>How TaskLocal Works</h2>\n<h3>Value Binding and Propagation</h3>\n<p>When you bind a value to a TaskLocal, it’s stored in the current task’s context. Any child tasks created within that scope automatically inherit this value:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">await</span> <span class=\"token class-name\">MyContext</span><span class=\"token punctuation\">.</span>$requestID<span class=\"token punctuation\">.</span><span class=\"token function\">withValue</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"req-123\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MyContext</span><span class=\"token punctuation\">.</span>requestID<span class=\"token punctuation\">)</span> <span class=\"token comment\">// \"req-123\"</span>\n    \n    <span class=\"token keyword\">await</span> <span class=\"token class-name\">Task</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MyContext</span><span class=\"token punctuation\">.</span>requestID<span class=\"token punctuation\">)</span> <span class=\"token comment\">// Still \"req-123\" - inherited!</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span>value\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MyContext</span><span class=\"token punctuation\">.</span>requestID<span class=\"token punctuation\">)</span> <span class=\"token comment\">// nil - outside the scope</span></code></pre></div>\n<p>This is fundamentally different from global variables or thread-local storage. The value is scoped to the <code class=\"language-text\">withValue</code> closure, and child tasks capture their parent’s values at creation time.</p>\n<h3>Under the Hood</h3>\n<p>Swift maintains a linked list of TaskLocal bindings in each task’s metadata. When you access a TaskLocal value, the runtime walks up the task hierarchy, checking each task’s bindings until it finds the value or reaches the top.</p>\n<p>This design makes TaskLocal:</p>\n<ul>\n<li><strong>Scoped</strong>: Values only exist within the <code class=\"language-text\">withValue</code> closure</li>\n<li><strong>Inherited</strong>: Child tasks get parent values at creation time (not dynamically)</li>\n<li><strong>Copy-on-write</strong>: Mutations don’t affect other tasks</li>\n<li><strong>Efficient</strong>: Reading is relatively cheap, though not as fast as a regular variable</li>\n</ul>\n<h2>Five Practical iOS Use Cases</h2>\n<p>Let’s explore real-world scenarios where TaskLocal shines in iOS development.</p>\n<h3>1. Analytics and Event Tracking</h3>\n<p>Track user journey context across async operations without passing parameters through every function:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">AnalyticsContext</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute atrule\">@TaskLocal</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> screenName<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span>\n    <span class=\"token attribute atrule\">@TaskLocal</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> featureFlag<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ProfileViewModel</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">loadUserProfile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> <span class=\"token class-name\">AnalyticsContext</span><span class=\"token punctuation\">.</span>$screenName<span class=\"token punctuation\">.</span><span class=\"token function\">withValue</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"ProfileScreen\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">await</span> <span class=\"token class-name\">AnalyticsContext</span><span class=\"token punctuation\">.</span>$featureFlag<span class=\"token punctuation\">.</span><span class=\"token function\">withValue</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"new_profile_ui\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetchProfile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token comment\">// Any analytics events fired deep in the call stack</span>\n                <span class=\"token comment\">// automatically get screenName and featureFlag context</span>\n                <span class=\"token keyword\">await</span> <span class=\"token function\">processData</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Every analytics event fired anywhere in this call tree automatically includes the screen name and feature flag, without explicitly passing them through dozens of functions.</p>\n<h3>2. Network Request Context</h3>\n<p>Propagate authentication tokens and correlation IDs through your networking layer:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">NetworkContext</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute atrule\">@TaskLocal</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> authToken<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span>\n    <span class=\"token attribute atrule\">@TaskLocal</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> correlationID<span class=\"token punctuation\">:</span> <span class=\"token constant\">UUID</span><span class=\"token operator\">?</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">APIClient</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">fetchUserData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">User</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> <span class=\"token class-name\">NetworkContext</span><span class=\"token punctuation\">.</span>$correlationID<span class=\"token punctuation\">.</span><span class=\"token function\">withValue</span><span class=\"token punctuation\">(</span><span class=\"token function\">UUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// All network calls in this tree automatically include</span>\n            <span class=\"token comment\">// the correlation ID in headers for distributed tracing</span>\n            <span class=\"token keyword\">let</span> profile <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"/user/profile\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">let</span> settings <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"/user/settings\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">:</span> profile<span class=\"token punctuation\">,</span> settings<span class=\"token punctuation\">:</span> settings<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">get</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> path<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Data</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> request <span class=\"token operator\">=</span> <span class=\"token class-name\">URLRequest</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">:</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> path<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">)</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> token <span class=\"token operator\">=</span> <span class=\"token class-name\">NetworkContext</span><span class=\"token punctuation\">.</span>authToken <span class=\"token punctuation\">{</span>\n            request<span class=\"token punctuation\">.</span><span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Bearer </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">token</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span> \n                           forHTTPHeaderField<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Authorization\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> correlationID <span class=\"token operator\">=</span> <span class=\"token class-name\">NetworkContext</span><span class=\"token punctuation\">.</span>correlationID <span class=\"token punctuation\">{</span>\n            request<span class=\"token punctuation\">.</span><span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>correlationID<span class=\"token punctuation\">.</span>uuidString<span class=\"token punctuation\">,</span> \n                           forHTTPHeaderField<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"X-Correlation-ID\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token comment\">// Perform request...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This pattern is invaluable for distributed tracing and debugging production issues. Every request in the chain shares the same correlation ID without manual threading.</p>\n<h3>3. Database Transaction Scoping</h3>\n<p>Maintain transaction context through Core Data or other database operations:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">DatabaseContext</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute atrule\">@TaskLocal</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> transaction<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DatabaseTransaction</span><span class=\"token operator\">?</span>\n    <span class=\"token attribute atrule\">@TaskLocal</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> isReadOnly<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">UserRepository</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">updateUserWithRelations</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">:</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">throws</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> transaction <span class=\"token operator\">=</span> database<span class=\"token punctuation\">.</span><span class=\"token function\">beginTransaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        \n        <span class=\"token keyword\">try</span> <span class=\"token keyword\">await</span> <span class=\"token class-name\">DatabaseContext</span><span class=\"token punctuation\">.</span>$transaction<span class=\"token punctuation\">.</span><span class=\"token function\">withValue</span><span class=\"token punctuation\">(</span>transaction<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">await</span> <span class=\"token class-name\">DatabaseContext</span><span class=\"token punctuation\">.</span>$isReadOnly<span class=\"token punctuation\">.</span><span class=\"token function\">withValue</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">try</span> <span class=\"token keyword\">await</span> <span class=\"token function\">saveUser</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">try</span> <span class=\"token keyword\">await</span> <span class=\"token function\">saveUserSettings</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>settings<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">try</span> <span class=\"token keyword\">await</span> <span class=\"token function\">saveUserPreferences</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>preferences<span class=\"token punctuation\">)</span>\n                <span class=\"token comment\">// All operations use the same transaction automatically</span>\n                <span class=\"token keyword\">try</span> <span class=\"token keyword\">await</span> transaction<span class=\"token punctuation\">.</span><span class=\"token function\">commit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Deep in your data access layer, you can check <code class=\"language-text\">DatabaseContext.transaction</code> to ensure you’re using the correct transaction scope, preventing subtle bugs from mixing transactional and non-transactional operations.</p>\n<h3>4. Logging Context</h3>\n<p>Enrich logs with contextual information throughout the call stack:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">LoggingContext</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute atrule\">@TaskLocal</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> userID<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span>\n    <span class=\"token attribute atrule\">@TaskLocal</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> sessionID<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span>\n    <span class=\"token attribute atrule\">@TaskLocal</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> operation<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">CheckoutFlow</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">processCheckout</span><span class=\"token punctuation\">(</span>cart<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Cart</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> <span class=\"token class-name\">LoggingContext</span><span class=\"token punctuation\">.</span>$userID<span class=\"token punctuation\">.</span><span class=\"token function\">withValue</span><span class=\"token punctuation\">(</span>cart<span class=\"token punctuation\">.</span>userID<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">await</span> <span class=\"token class-name\">LoggingContext</span><span class=\"token punctuation\">.</span>$sessionID<span class=\"token punctuation\">.</span><span class=\"token function\">withValue</span><span class=\"token punctuation\">(</span><span class=\"token function\">UUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>uuidString<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">await</span> <span class=\"token class-name\">LoggingContext</span><span class=\"token punctuation\">.</span>$operation<span class=\"token punctuation\">.</span><span class=\"token function\">withValue</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"checkout\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    logger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Starting checkout\"</span></span><span class=\"token punctuation\">)</span> \n                    <span class=\"token comment\">// Logs: [userID=123, sessionID=abc, operation=checkout] Starting checkout</span>\n                    \n                    <span class=\"token keyword\">await</span> <span class=\"token function\">validateCart</span><span class=\"token punctuation\">(</span>cart<span class=\"token punctuation\">)</span>\n                    <span class=\"token keyword\">await</span> <span class=\"token function\">processPayment</span><span class=\"token punctuation\">(</span>cart<span class=\"token punctuation\">)</span>\n                    <span class=\"token keyword\">await</span> <span class=\"token function\">createOrder</span><span class=\"token punctuation\">(</span>cart<span class=\"token punctuation\">)</span>\n                    <span class=\"token comment\">// All nested operations automatically include context</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Your logging infrastructure can automatically include TaskLocal values in every log entry, making it trivial to trace a user’s journey through your system.</p>\n<h3>5. Feature Flags and A/B Testing</h3>\n<p>Propagate experiment configurations through view models and services:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">ExperimentContext</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute atrule\">@TaskLocal</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> variant<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span>\n    <span class=\"token attribute atrule\">@TaskLocal</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> experimentID<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ProductListViewModel</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ObservableObject</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">loadProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> experiment <span class=\"token operator\">=</span> experimentService<span class=\"token punctuation\">.</span><span class=\"token function\">getActiveExperiment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        \n        <span class=\"token keyword\">await</span> <span class=\"token class-name\">ExperimentContext</span><span class=\"token punctuation\">.</span>$experimentID<span class=\"token punctuation\">.</span><span class=\"token function\">withValue</span><span class=\"token punctuation\">(</span>experiment<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">await</span> <span class=\"token class-name\">ExperimentContext</span><span class=\"token punctuation\">.</span>$variant<span class=\"token punctuation\">.</span><span class=\"token function\">withValue</span><span class=\"token punctuation\">(</span>experiment<span class=\"token punctuation\">.</span>variant<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">let</span> products <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetchProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                \n                <span class=\"token comment\">// Sorting algorithm can check variant without passing params</span>\n                <span class=\"token keyword\">let</span> sorted <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">sortProducts</span><span class=\"token punctuation\">(</span>products<span class=\"token punctuation\">)</span>\n                \n                <span class=\"token comment\">// Analytics automatically tagged with experiment context</span>\n                <span class=\"token function\">trackEvent</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"products_loaded\"</span></span><span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">:</span> sorted<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">sortProducts</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> products<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">switch</span> <span class=\"token class-name\">ExperimentContext</span><span class=\"token punctuation\">.</span>variant <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token string-literal\"><span class=\"token string\">\"personalized\"</span></span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> <span class=\"token function\">personalizedSort</span><span class=\"token punctuation\">(</span>products<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">case</span> <span class=\"token string-literal\"><span class=\"token string\">\"popular\"</span></span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> <span class=\"token function\">popularitySort</span><span class=\"token punctuation\">(</span>products<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> products\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The beauty here is that your sorting logic, analytics, and any other code can access the experiment context without it being explicitly threaded through every function signature.</p>\n<h2>Why Point-Free Built @Dependency on TaskLocal</h2>\n<p>Point-Free’s <code class=\"language-text\">@Dependency</code> library is one of the most elegant dependency injection systems in Swift, and it’s built entirely on TaskLocal. Let’s explore why this architectural choice is so brilliant.</p>\n<h3>1. Automatic Propagation Through Async Boundaries</h3>\n<p>Modern iOS apps are full of async/await. Dependencies need to flow through your entire call graph:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token attribute atrule\">@Dependency</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">\\</span><span class=\"token punctuation\">.</span>apiClient<span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> apiClient\n<span class=\"token attribute atrule\">@Dependency</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">\\</span><span class=\"token punctuation\">.</span>database<span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> database\n\n<span class=\"token keyword\">func</span> <span class=\"token function-definition function\">loadUserData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// These dependencies automatically propagate to child tasks</span>\n    <span class=\"token keyword\">async</span> <span class=\"token keyword\">let</span> profile <span class=\"token operator\">=</span> <span class=\"token function\">fetchProfile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">async</span> <span class=\"token keyword\">let</span> orders <span class=\"token operator\">=</span> <span class=\"token function\">fetchOrders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token keyword\">await</span> <span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">,</span> orders<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// fetchProfile and fetchOrders can access the same dependencies</span>\n    <span class=\"token comment\">// without explicitly passing them</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Without TaskLocal, you’d need to manually thread dependencies through every async boundary or resort to global singletons. TaskLocal gives you the best of both worlds: clean code with proper scoping.</p>\n<h3>2. Test Overrides That Respect Concurrency</h3>\n<p>The killer feature for testing - you can override dependencies in a scope and they propagate correctly through concurrent operations:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">testUserLogin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">await</span> withDependencies <span class=\"token punctuation\">{</span>\n        <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>apiClient <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span>mock\n        <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>uuid <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span>incrementing\n    <span class=\"token punctuation\">}</span> operation<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// All async tasks created here see the mock dependencies</span>\n        <span class=\"token keyword\">let</span> viewModel <span class=\"token operator\">=</span> <span class=\"token class-name\">LoginViewModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">await</span> viewModel<span class=\"token punctuation\">.</span><span class=\"token function\">login</span><span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"test@example.com\"</span></span><span class=\"token punctuation\">)</span>\n        \n        <span class=\"token comment\">// Even though login() spawns multiple child tasks,</span>\n        <span class=\"token comment\">// they all see the mocked apiClient</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This is <strong>much harder</strong> with traditional dependency injection. TaskLocal ensures test isolation even when code spawns concurrent tasks internally. Each test gets its own dependency context that doesn’t leak into other tests.</p>\n<h3>3. Avoiding Global Mutable State</h3>\n<p>Traditional DI often relies on global singletons or environment objects. TaskLocal provides a better alternative:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">// NOT this (global, mutable, threading issues):</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">DependencyContainer</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> shared <span class=\"token operator\">=</span> <span class=\"token class-name\">DependencyContainer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">var</span> apiClient<span class=\"token punctuation\">:</span> <span class=\"token class-name\">APIClient</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// But THIS (scoped, immutable, thread-safe):</span>\n<span class=\"token keyword\">enum</span> <span class=\"token class-name\">DependencyValues</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute atrule\">@TaskLocal</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> current <span class=\"token operator\">=</span> <span class=\"token class-name\">DependencyValues</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Each task tree gets its own dependency context without shared mutable state. This eliminates entire classes of bugs related to concurrent access.</p>\n<h3>4. SwiftUI Preview Support</h3>\n<p>Previews can override dependencies cleanly:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token other-directive property\">#Preview</span> <span class=\"token punctuation\">{</span>\n    withDependencies <span class=\"token punctuation\">{</span>\n        <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>apiClient <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span>previewData\n        <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>currentDate <span class=\"token operator\">=</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span>timeIntervalSince1970<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> operation<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">UserProfileView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The preview’s async operations all inherit the preview dependencies. This is <strong>critical</strong> for Xcode previews that need isolated environments. Without TaskLocal, you’d be fighting with global state and risking contamination between previews.</p>\n<h3>5. Avoiding “Dependency Hell” in Init Methods</h3>\n<p>Without TaskLocal, you’d write this monstrosity:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewModel</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>\n        apiClient<span class=\"token punctuation\">:</span> <span class=\"token class-name\">APIClient</span><span class=\"token punctuation\">,</span>\n        database<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Database</span><span class=\"token punctuation\">,</span>\n        analytics<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Analytics</span><span class=\"token punctuation\">,</span>\n        logger<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Logger</span><span class=\"token punctuation\">,</span>\n        uuid<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UUIDGenerator</span><span class=\"token punctuation\">,</span>\n        dateGenerator<span class=\"token punctuation\">:</span> <span class=\"token class-name\">DateGenerator</span><span class=\"token punctuation\">,</span>\n        <span class=\"token comment\">// ... and 10 more dependencies</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Store all these...</span>\n        <span class=\"token comment\">// Pass them to helper methods...</span>\n        <span class=\"token comment\">// Cry a little...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>With TaskLocal-backed dependencies:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewModel</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute atrule\">@Dependency</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">\\</span><span class=\"token punctuation\">.</span>apiClient<span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> apiClient\n    <span class=\"token attribute atrule\">@Dependency</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">\\</span><span class=\"token punctuation\">.</span>database<span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> database\n    <span class=\"token comment\">// Dependencies available everywhere, no init pollution</span>\n    \n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Your initializers stay clean, and you don’t need to pass dependencies through layers of helper methods.</p>\n<h3>6. Hierarchical Overrides</h3>\n<p>You can nest dependency scopes, with inner scopes overriding outer ones:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">await</span> withDependencies <span class=\"token punctuation\">{</span>\n    <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>apiClient <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span>production\n<span class=\"token punctuation\">}</span> operation<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Uses production apiClient</span>\n    \n    <span class=\"token keyword\">await</span> withDependencies <span class=\"token punctuation\">{</span>\n        <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>apiClient <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span>staging  <span class=\"token comment\">// Overrides production</span>\n    <span class=\"token punctuation\">}</span> operation<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Uses staging apiClient</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">// Back to production here</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>TaskLocal’s scoping semantics make this natural and safe. You can have different dependency configurations for different parts of your application, all running concurrently without interference.</p>\n<h3>7. Live vs Test vs Preview Contexts</h3>\n<p>Point-Free can provide different dependency configurations per context:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">DependencyValues</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">let</span> live <span class=\"token operator\">=</span> <span class=\"token comment\">/* production dependencies */</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">let</span> test <span class=\"token operator\">=</span> <span class=\"token comment\">/* test doubles */</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">let</span> preview <span class=\"token operator\">=</span> <span class=\"token comment\">/* preview data */</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>TaskLocal ensures these contexts don’t leak between test runs or affect each other. Each context is isolated and safe.</p>\n<h2>The Alternative (and Why It’s Worse)</h2>\n<p>What would Point-Free have done without TaskLocal? The alternatives all have significant drawbacks:</p>\n<h3>Thread-Local Storage</h3>\n<p>Breaks completely with async/await. Your code can hop between threads, and thread-local values don’t propagate with the task.</p>\n<h3>Global Singletons</h3>\n<p>Hard to test, race conditions everywhere, no isolation between tests or different parts of your app running concurrently.</p>\n<h3>Manual Parameter Passing</h3>\n<p>Tedious, error-prone, and makes refactoring a nightmare. Every function signature becomes polluted with dependencies.</p>\n<h3>Environment Objects</h3>\n<p>SwiftUI-only, doesn’t help in view models, repositories, or service layers where most of your business logic lives.</p>\n<p>TaskLocal elegantly solves all these problems by giving developers scoped, inherited, concurrency-safe storage that works everywhere in Swift.</p>\n<h2>Best Practices</h2>\n<p>When using TaskLocal in your own code:</p>\n<ol>\n<li>\n<p><strong>Use for context, not data</strong>: TaskLocal is perfect for request IDs, user sessions, and configuration. It’s not a replacement for passing actual data through function parameters.</p>\n</li>\n<li>\n<p><strong>Keep values lightweight</strong>: TaskLocal values are copied when tasks are created. Heavy objects can impact performance.</p>\n</li>\n<li>\n<p><strong>Document your TaskLocals</strong>: Make it clear what each TaskLocal is for and when it should be set.</p>\n</li>\n<li>\n<p><strong>Provide sensible defaults</strong>: Use optional types or provide default values so code doesn’t crash when TaskLocal isn’t set.</p>\n</li>\n<li>\n<p><strong>Test with different values</strong>: Ensure your code behaves correctly when TaskLocal values change between parent and child tasks.</p>\n</li>\n</ol>\n<h2>Conclusion</h2>\n<p>TaskLocal is one of those features that doesn’t get enough attention but solves real problems elegantly. It enables patterns that would be difficult or impossible otherwise, particularly in the world of structured concurrency.</p>\n<p>Point-Free’s decision to build their <code class=\"language-text\">@Dependency</code> library on TaskLocal shows the power of the primitive. It’s not just about avoiding global state - it’s about creating a dependency injection system that truly respects Swift’s concurrency model.</p>\n<p>If you’re building iOS apps with async/await, understanding TaskLocal will level up your architecture. Whether you use Point-Free’s library or roll your own context propagation system, TaskLocal is the tool you need.</p>\n<p>Next time you find yourself threading parameters through five layers of async functions, remember: TaskLocal might be exactly what you need.</p>","frontmatter":{"title":"TaskLocal in Swift: The Secret Weapon for Clean Async Code","date":"January 21, 2026","tags":["Swift","iOS","Concurrency","Dependency Injection","Architecture"]}},"previous":null,"next":{"fields":{"slug":"/async-await-internals/"},"frontmatter":{"title":"Deep Dive: How Async/Await Works Under the Hood in Swift"}}},"pageContext":{"id":"b1e4f645-af8f-5ee4-a2eb-cd99156f2003","slug":"/tasklocal-swift/","previousPostId":null,"nextPostId":"239dbc59-49bc-584e-aca2-e2432602ea43"}},"staticQueryHashes":["63159454"],"slicesMap":{}}