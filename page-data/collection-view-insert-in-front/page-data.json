{"componentChunkName":"component---src-templates-blog-post-js","path":"/collection-view-insert-in-front/","result":{"data":{"site":{"siteMetadata":{"title":"Journey before destination, tests before production"}},"markdownRemark":{"id":"702ad07c-baca-58b1-863d-56ebff98665b","excerpt":"While improving the Chat UI at Sphere, we ran into a problem I couldn’t find a good solution for online: maintaining smooth scroll position when prepending…","html":"<p>While improving the Chat UI at <a href=\"https://www.sphere.me\">Sphere</a>, we ran into a problem I couldn’t find a good solution for online: maintaining smooth scroll position when prepending items to a collection view.</p>\n<p>The scenario: users scroll up through chat history, triggering pagination. New messages load at the top of the collection view, but the scroll position shouldn’t jump—users should stay exactly where they were.</p>\n<p>Here’s the result:</p>\n<div style=\"text-align:center\"><img src=\"/e7555677ed886c4626d40edf8706883e/scroll_to_top.gif\"></div>\n<h2>The approach</h2>\n<p>The solution relies on four key pieces:</p>\n<ol>\n<li>Detect when items are being prepended by analyzing the diff of state changes</li>\n<li>Capture the content size before batch updates</li>\n<li>Capture the content offset in <a href=\"https://developer.apple.com/documentation/uikit/uicollectionviewlayout/1617771-invalidatelayout\">invalidateLayout(with:)</a>—called right before batch updates execute</li>\n<li>Return the adjusted offset from <a href=\"https://developer.apple.com/documentation/uikit/uicollectionviewlayout/1617724-targetcontentoffset\">targetContentOffset(forProposedContentOffset:)</a></li>\n</ol>\n<h2>The implementation</h2>\n<p>Custom layout subclass:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MessageListLayout</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">UICollectionViewFlowLayout</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> isPrepending<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> prevContentHeight<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CGFloat</span><span class=\"token operator\">?</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> contentOffsetBeforeUpdate<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CGPoint</span><span class=\"token operator\">?</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">invalidateLayout</span><span class=\"token punctuation\">(</span>with context<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UICollectionViewLayoutInvalidationContext</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Called before batch updates—capture state here</span>\n        prevContentHeight <span class=\"token operator\">=</span> collectionViewContentSize<span class=\"token punctuation\">.</span>height\n        contentOffsetBeforeUpdate <span class=\"token operator\">=</span> collectionView<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span>contentOffset\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">invalidateLayout</span><span class=\"token punctuation\">(</span>with<span class=\"token punctuation\">:</span> context<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">targetContentOffset</span><span class=\"token punctuation\">(</span>forProposedContentOffset proposedContentOffset<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CGPoint</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">CGPoint</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">guard</span>\n            <span class=\"token keyword\">let</span> prevHeight <span class=\"token operator\">=</span> prevContentHeight<span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">let</span> prevOffset <span class=\"token operator\">=</span> contentOffsetBeforeUpdate<span class=\"token punctuation\">,</span>\n            isPrepending\n        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">targetContentOffset</span><span class=\"token punctuation\">(</span>forProposedContentOffset<span class=\"token punctuation\">:</span> proposedContentOffset<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// Calculate how much content height changed</span>\n        <span class=\"token keyword\">let</span> delta <span class=\"token operator\">=</span> collectionViewContentSize<span class=\"token punctuation\">.</span>height <span class=\"token operator\">-</span> prevHeight\n\n        <span class=\"token comment\">// Offset by delta so the visible content stays in place</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">CGPoint</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">:</span> proposedContentOffset<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">:</span> prevOffset<span class=\"token punctuation\">.</span>y <span class=\"token operator\">+</span> delta<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Collection view adapter:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">performUpdate</span><span class=\"token punctuation\">(</span>sections<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">Section</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> changes <span class=\"token operator\">=</span> <span class=\"token class-name\">StagedChangeset</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">:</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>sections<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">:</span> sections<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> wasEmpty <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>sections<span class=\"token punctuation\">.</span>isEmpty\n\n    <span class=\"token comment\">// Determine the type of change</span>\n    <span class=\"token keyword\">let</span> nature <span class=\"token operator\">=</span> <span class=\"token function\">changeNature</span><span class=\"token punctuation\">(</span>of<span class=\"token punctuation\">:</span> changes<span class=\"token punctuation\">,</span> wasInitiallyEmpty<span class=\"token punctuation\">:</span> wasEmpty<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// Signal to layout that we're prepending</span>\n    layout<span class=\"token punctuation\">.</span>isPrepending <span class=\"token operator\">=</span> nature <span class=\"token operator\">==</span> <span class=\"token punctuation\">.</span>prependingHistory\n\n    <span class=\"token comment\">// Batch updates—layout handles the offset adjustment</span>\n    <span class=\"token function\">reloadWithSilentCellUpdate</span><span class=\"token punctuation\">(</span>changes<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The key insight: <code class=\"language-text\">invalidateLayout(with:)</code> fires before the batch update applies, giving you a window to snapshot the current state. Then <code class=\"language-text\">targetContentOffset(forProposedContentOffset:)</code> lets you adjust where the collection view lands after the update. The delta between old and new content height is exactly how much to shift the offset to keep the visible content stationary.</p>","frontmatter":{"title":"Inserting Dynamic Height Cells While Preserving Scroll Position","date":"June 25, 2021","tags":["iOS","UIKit","UICollectionView"]}},"previous":{"fields":{"slug":"/efficient-pr-reviews/"},"frontmatter":{"title":"Efficient PR reviews"}},"next":{"fields":{"slug":"/custom-environment-swift-ui/"},"frontmatter":{"title":"Custom @Environment Keys in SwiftUI"}}},"pageContext":{"id":"702ad07c-baca-58b1-863d-56ebff98665b","slug":"/collection-view-insert-in-front/","previousPostId":"a8154907-905b-597d-abd1-8521d10ff9fa","nextPostId":"a2ca0b0d-d121-5db6-82da-b14235194fc9"}},"staticQueryHashes":["63159454"],"slicesMap":{}}