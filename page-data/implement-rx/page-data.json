{"componentChunkName":"component---src-templates-blog-post-js","path":"/implement-rx/","result":{"data":{"site":{"siteMetadata":{"title":"iOS Developer in search for meaning üßò‚Äç‚ôÇÔ∏è"}},"markdownRemark":{"id":"7740deba-788a-5166-9192-a8e78d256b62","excerpt":"There are several ways to learn a new technology: Read about it Play with it Implement something similar Most tutorials cover the first two. This article takes‚Ä¶","html":"<p>There are several ways to learn a new technology:</p>\n<ul>\n<li>Read about it</li>\n<li>Play with it</li>\n<li>Implement something similar</li>\n</ul>\n<p>Most tutorials cover the first two. This article takes the third approach: we‚Äôll build a working (if simplified) version of RxSwift from scratch.</p>\n<h2>Observable</h2>\n<p>The <a href=\"https://github.com/ReactiveX/RxSwift/blob/master/RxSwift/ObservableType.swift\">Observable interface</a> is surprisingly minimal:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">protocol</span> <span class=\"token class-name\">ObservableType</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">associatedtype</span> <span class=\"token class-name\">E</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">subscribe</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">O</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ObserverType</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">:</span> <span class=\"token class-name\">O</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Disposable</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">O</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">E</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">E</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>One method: pass an <strong>Observer</strong>, get back a <strong>Disposable</strong> for unsubscribing.</p>\n<h2>Observer</h2>\n<p>An Observer handles events:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">protocol</span> <span class=\"token class-name\">ObserverType</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">associatedtype</span> <span class=\"token class-name\">E</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">on</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Event</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">Event</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">case</span> <span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Error</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">case</span> completed\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Disposable</h2>\n<p>Disposable has a single responsibility‚Äîcleanup. When <code class=\"language-text\">dispose()</code> is called, it releases resources (network connections, database handles, etc.):</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">protocol</span> <span class=\"token class-name\">Disposable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Building the types</h2>\n<p>Starting from the bottom:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AnonymousDisposable</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Disposable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> disposeClosure<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Void</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> disposeClosure<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>disposeClosure <span class=\"token operator\">=</span> disposeClosure\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">disposeClosure</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CompositeDisposable</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Disposable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> isDisposed <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> disposables<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">Disposable</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">add</span><span class=\"token punctuation\">(</span>disposable<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Disposable</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> isDisposed <span class=\"token punctuation\">{</span>\n            disposable<span class=\"token punctuation\">.</span><span class=\"token function\">dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span>\n        <span class=\"token punctuation\">}</span>\n        disposables<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>disposable<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> isDisposed <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">}</span>\n        disposables<span class=\"token punctuation\">.</span>forEach <span class=\"token punctuation\">{</span> <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span><span class=\"token function\">dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n        isDisposed <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">AnonymousDisposable</code> wraps a cleanup closure. <code class=\"language-text\">CompositeDisposable</code> aggregates multiple disposables‚Äîwhen disposed, it disposes all children. Adding to an already-disposed composite immediately disposes the new item.</p>\n<p><code class=\"language-text\">Observer</code> wraps an event handler:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Observer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token operator\">></span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ObserverType</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> handler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Event</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Void</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> handler<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Event</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>handler <span class=\"token operator\">=</span> handler\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">on</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Event</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now for <code class=\"language-text\">Observable</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Observable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Element</span><span class=\"token operator\">></span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ObservableType</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">typealias</span> <span class=\"token class-name\">E</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Element</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> subscribeHandler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Observer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Element</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Disposable</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> subscriptionClosure<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Observer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Element</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Disposable</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>subscribeHandler <span class=\"token operator\">=</span> subscriptionClosure\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">subscribe</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">O</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ObserverType</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">:</span> <span class=\"token class-name\">O</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Disposable</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">O</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">E</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">E</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> composite <span class=\"token operator\">=</span> <span class=\"token class-name\">CompositeDisposable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> subscription <span class=\"token operator\">=</span> <span class=\"token function\">subscribeHandler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Observer</span> <span class=\"token punctuation\">{</span> event <span class=\"token keyword\">in</span>\n            observer<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">:</span> event<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">switch</span> event <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span>completed<span class=\"token punctuation\">:</span>\n                composite<span class=\"token punctuation\">.</span><span class=\"token function\">dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">break</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        composite<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>disposable<span class=\"token punctuation\">:</span> subscription<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> composite\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This works, but <code class=\"language-text\">subscribe(observer:)</code> is doing too much:</p>\n<ul>\n<li>Managing disposables</li>\n<li>Forwarding events</li>\n<li>Checking disposal state before forwarding</li>\n</ul>\n<p>Let‚Äôs extract this into a <code class=\"language-text\">Sink</code>‚Äîlike a kitchen sink, it defines how the ‚Äústream‚Äù flows and handles cleanup:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Sink</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">O</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ObserverType</span><span class=\"token operator\">></span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Disposable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> disposed <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> forward<span class=\"token punctuation\">:</span> <span class=\"token class-name\">O</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> subscriptionHandler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Observer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">O</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">E</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Disposable</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> composite <span class=\"token operator\">=</span> <span class=\"token class-name\">CompositeDisposable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>forward<span class=\"token punctuation\">:</span> <span class=\"token class-name\">O</span><span class=\"token punctuation\">,</span> subscriptionHandler<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Observer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">O</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">E</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Disposable</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>forward <span class=\"token operator\">=</span> forward\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>subscriptionHandler <span class=\"token operator\">=</span> subscriptionHandler\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> observer <span class=\"token operator\">=</span> <span class=\"token class-name\">Observer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">O</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">E</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>forwardEvent<span class=\"token punctuation\">)</span>\n        composite<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>disposable<span class=\"token punctuation\">:</span> <span class=\"token function\">subscriptionHandler</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">forwardEvent</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> event<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Event</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">O</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">E</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> disposed <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">}</span>\n        forward<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">:</span> event<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">switch</span> event <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span>completed<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">:</span>\n            <span class=\"token function\">dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">break</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        disposed <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n        composite<span class=\"token punctuation\">.</span><span class=\"token function\">dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now <code class=\"language-text\">Observable</code> becomes clean:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Observable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Element</span><span class=\"token operator\">></span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ObservableType</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">typealias</span> <span class=\"token class-name\">E</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Element</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> subscribeHandler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Observer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Element</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Disposable</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> subscriptionClosure<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Observer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Element</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Disposable</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        subscribeHandler <span class=\"token operator\">=</span> subscriptionClosure\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">subscribe</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">O</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ObserverType</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">:</span> <span class=\"token class-name\">O</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Disposable</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">O</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">E</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">E</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> sink <span class=\"token operator\">=</span> <span class=\"token class-name\">Sink</span><span class=\"token punctuation\">(</span>forward<span class=\"token punctuation\">:</span> observer<span class=\"token punctuation\">,</span> subscriptionHandler<span class=\"token punctuation\">:</span> subscribeHandler<span class=\"token punctuation\">)</span>\n        sink<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> sink\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Let‚Äôs verify it works:</p>\n<p><img src=\"/348c3b53b16273b3614ca10f66516679/observable.gif\" alt=\"observable\"></p>\n<h2>Adding operators</h2>\n<p>The real power of Rx comes from operators. Let‚Äôs implement <code class=\"language-text\">map</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">ObservableType</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">map</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">U</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> transform<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">U</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Observable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">U</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Observable</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">U</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span> observer <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Observer</span> <span class=\"token punctuation\">{</span> event <span class=\"token keyword\">in</span>\n                <span class=\"token keyword\">switch</span> event <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> element<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">try</span> observer<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token function\">transform</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n                        observer<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                    observer<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">case</span> <span class=\"token punctuation\">.</span>completed<span class=\"token punctuation\">:</span>\n                    observer<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>completed<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><img src=\"/f6310a7eae896c40a405bc8aa4d20875/map.gif\" alt=\"map\"></p>\n<h2>Recap</h2>\n<p><code class=\"language-text\">Observable</code> is a type you subscribe to by passing an <code class=\"language-text\">Observer</code>. The key insight: all the work happens in <code class=\"language-text\">subscribe</code>. You can chain and transform observables without triggering any side effects‚Äînothing executes until subscription.</p>\n<h2>Conclusion</h2>\n<p>This implementation is naive and not production-ready. But hopefully it demystifies Rx‚Äîthere‚Äôs no magic here, just closures and protocols.</p>\n<p>Playground available <a href=\"https://github.com/sergdort/HandMadeRx\">here</a>.</p>\n<h2>Further reading</h2>\n<ul>\n<li><a href=\"https://github.com/ReactiveX/RxSwift\">RxSwift repo</a></li>\n<li><a href=\"http://reactivex.io/\">ReactiveX website</a></li>\n<li><a href=\"https://store.raywenderlich.com/products/rxswift\">RxSwift book by Ray Wenderlich team</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=looJcaeboBY\">Math behind Rx</a></li>\n</ul>","frontmatter":{"title":"Learn Rx by Implementing Observable","date":"June 06, 2017"}},"previous":{"fields":{"slug":"/component-based-tv/"},"frontmatter":{"title":"Component-Based UITableView"}},"next":{"fields":{"slug":"/view-model-in-rx/"},"frontmatter":{"title":"ViewModel in RxSwift World"}}},"pageContext":{"id":"7740deba-788a-5166-9192-a8e78d256b62","slug":"/implement-rx/","previousPostId":"c832c5af-5047-59d3-9b57-95940de139b6","nextPostId":"e7abbab4-0d6a-536d-9c7b-9df49e7e33c3"}},"staticQueryHashes":["63159454"],"slicesMap":{}}