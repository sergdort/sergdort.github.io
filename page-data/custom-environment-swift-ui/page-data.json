{"componentChunkName":"component---src-templates-blog-post-js","path":"/custom-environment-swift-ui/","result":{"data":{"site":{"siteMetadata":{"title":"Journey before destination, tests before production"}},"markdownRemark":{"id":"a2ca0b0d-d121-5db6-82da-b14235194fc9","excerpt":"is a property wrapper that gives views access to shared dependencies—, , , and others built into SwiftUI. But what about app-specific dependencies? Say you want…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b756e3cdd240c13bce17e6ae117dc83c/ee745/environment.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgT/xAAWAQEBAQAAAAAAAAAAAAAAAAACAwT/2gAMAwEAAhADEAAAAcD0XhngaE//xAAaEAACAwEBAAAAAAAAAAAAAAAAAgERMQNC/9oACAEBAAEFAtObQqnq7Iz/xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPwFX/8QAFREBAQAAAAAAAAAAAAAAAAAAERD/2gAIAQIBAT8BGf/EABkQAAIDAQAAAAAAAAAAAAAAAAABEBExUf/aAAgBAQAGPwLSnDHfI//EABkQAQADAQEAAAAAAAAAAAAAAAEAESExQf/aAAgBAQABPyEC2BijH0ndlBC5Wl6mCUT/2gAMAwEAAgADAAAAEGTP/8QAFxEBAAMAAAAAAAAAAAAAAAAAAAEhQf/aAAgBAwEBPxDU2f/EABYRAQEBAAAAAAAAAAAAAAAAAAEAMf/aAAgBAgEBPxBwlv/EABsQAQEAAgMBAAAAAAAAAAAAAAERAEEhMWFx/9oACAEBAAE/EFAhFLvEMoYbfMHs7WsyCgkXnWMQyKOT5jCkA2Z//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"environment\"\n        title=\"\"\n        src=\"/static/b756e3cdd240c13bce17e6ae117dc83c/1c72d/environment.jpg\"\n        srcset=\"/static/b756e3cdd240c13bce17e6ae117dc83c/a80bd/environment.jpg 148w,\n/static/b756e3cdd240c13bce17e6ae117dc83c/1c91a/environment.jpg 295w,\n/static/b756e3cdd240c13bce17e6ae117dc83c/1c72d/environment.jpg 590w,\n/static/b756e3cdd240c13bce17e6ae117dc83c/ee745/environment.jpg 660w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><code class=\"language-text\">@Environment</code> is a property wrapper that gives views access to shared dependencies—<code class=\"language-text\">Calendar</code>, <code class=\"language-text\">Locale</code>, <code class=\"language-text\">ColorScheme</code>, and others built into SwiftUI.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">CalendarView</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">View</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute atrule\">@Environment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">\\</span><span class=\"token punctuation\">.</span>calendar<span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> calendar<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Calendar</span>\n\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">View</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>But what about app-specific dependencies? Say you want an <code class=\"language-text\">ImageFetcher</code> available to any view that displays remote images, with caching across screens.</p>\n<p>SwiftUI supports this through custom environment keys:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">MovieCell</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">View</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute atrule\">@Environment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">\\</span><span class=\"token punctuation\">.</span>imageFetcher<span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> fetcher<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ImageFetcher</span>\n    <span class=\"token keyword\">var</span> movie<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Movie</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> poster<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyPublisher</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">UIImage</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Never</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        fetcher<span class=\"token punctuation\">.</span><span class=\"token function\">image</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">:</span> movie<span class=\"token punctuation\">.</span>posterURL<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">View</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Implementation</h2>\n<p>Two pieces are required: an <code class=\"language-text\">EnvironmentKey</code> and an extension on <code class=\"language-text\">EnvironmentValues</code>.</p>\n<h3>Define the key</h3>\n<p><code class=\"language-text\">EnvironmentKey</code> requires a default value for your dependency:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">protocol</span> <span class=\"token class-name\">EnvironmentKey</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">associatedtype</span> <span class=\"token class-name\">Value</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> defaultValue<span class=\"token punctuation\">:</span> <span class=\"token keyword\">Self</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Value</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">ImageFetcherKey</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">EnvironmentKey</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">let</span> defaultValue <span class=\"token operator\">=</span> <span class=\"token class-name\">ImageFetcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">defaultValue</code> is instantiated lazily on first access via <code class=\"language-text\">@Environment</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/18c0050935c2bdcc2668497aa790bb26/bcec6/defaultValue.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.891891891891895%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABoElEQVR42o2R2W7bMBBF9TctLGqlVstSJceyrMSx471e5KZB0ZcCCdD+P07HQoq89uGAxJBzeS/HqE9/WD//ZnH6xap7Y929sr6+0e5/ctkWTEqbPLcZT2PSaYmuKnSWUhQho3FA0kaEchY1CboOMYrZgXbzQrN6ZrLoyOoNcfVEvbzycqwocg/L90gik1CwfQvlWViCHTuETUwyGzJss17YKO8vzHc/aNbfuHs8U8x2jES0ut9j2gGBp8ijAZ6ORWyE7yeE8oDnKpSpGHwyMT8PZB3IamIkswvVYydiJ8YiOJ4fKdsD4/sdSZoQaI84MMnymGEmMYcehURO40TEQyKtsGz7HQujqjua5XfulhcmT13PzW0+XREEAb7WWJYi0SZaXLmOI40ax3bFpYPvOTi3mmX1GHmxoZgeyNs9hTjLplvSyZqwmKFFMAg0trwc+Kp363oJnhfJ3u2/Iwg1WupKvQumX7YSUWI+fKWan4QjUbXAHzXS6OO6bn/x1qCUxBNUz0etr/9zGJYygIcT9eIsUz7LtK89cTmXaB9R/pe/SUkPu+BIOQoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"defaultValue\"\n        title=\"\"\n        src=\"/static/18c0050935c2bdcc2668497aa790bb26/fcda8/defaultValue.png\"\n        srcset=\"/static/18c0050935c2bdcc2668497aa790bb26/12f09/defaultValue.png 148w,\n/static/18c0050935c2bdcc2668497aa790bb26/e4a3f/defaultValue.png 295w,\n/static/18c0050935c2bdcc2668497aa790bb26/fcda8/defaultValue.png 590w,\n/static/18c0050935c2bdcc2668497aa790bb26/efc66/defaultValue.png 885w,\n/static/18c0050935c2bdcc2668497aa790bb26/c83ae/defaultValue.png 1180w,\n/static/18c0050935c2bdcc2668497aa790bb26/bcec6/defaultValue.png 1834w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>Expose the property</h3>\n<p>Extend <code class=\"language-text\">EnvironmentValues</code> to provide the key path used with <code class=\"language-text\">@Environment</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">EnvironmentValues</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> imageFetcher<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ImageFetcher</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">get</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">[</span><span class=\"token class-name\">ImageFetcherKey</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">set</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">[</span><span class=\"token class-name\">ImageFetcherKey</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newValue <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>That’s it. Any view can now access <code class=\"language-text\">@Environment(\\.imageFetcher)</code>.</p>\n<p>Full implementation available <a href=\"https://github.com/sergdort/CombineFeedback/blob/master/Example/Views/AsyncImage.swift\">here</a>.</p>","frontmatter":{"title":"Custom @Environment Keys in SwiftUI","date":"July 08, 2019","tags":["SwiftUI","iOS","dependency-injection"]}},"previous":{"fields":{"slug":"/collection-view-insert-in-front/"},"frontmatter":{"title":"Inserting Dynamic Height Cells While Preserving Scroll Position"}},"next":{"fields":{"slug":"/object-composition/"},"frontmatter":{"title":"The Power of Composition"}}},"pageContext":{"id":"a2ca0b0d-d121-5db6-82da-b14235194fc9","slug":"/custom-environment-swift-ui/","previousPostId":"702ad07c-baca-58b1-863d-56ebff98665b","nextPostId":"af2172ba-19d4-5f09-b72e-f078e67379d3"}},"staticQueryHashes":["63159454"],"slicesMap":{}}